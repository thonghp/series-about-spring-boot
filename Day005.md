# Unit test

## Mục lục nội dung

- [1. Chú thích các annotation](#1-chú-thích-các-annotation)
- [2. Test save](#2-test-save)
- [3. Test get](#3-test-get)
- [4. Test update](#4-test-update)
- [5. Test delete](#5-test-delete)
- [6. Test listAll](#6-test-listall)
- [7. Test findBy](#7-test-findby)
- [8. Test count](#8-test-count)

## 1. Chú thích các annotation

**Đoạn code demo**

```java
@DataJpaTest(showSql = false)
@AutoConfigureTestDatabase(replace = Replace.NONE)
@Rollback(false)
public class RoleRepositoryTest {
    @Autowired
    private RoleRepository repo; // inject an instance of RoleRepository

    /*
     * Cung cấp các phương thức để thực hiện các hoạt động truy vấn, thêm, 
     * sửa, xoá dữ liệu mà không cần phải tạo ra một cơ sở dữ liệu thật
     */ 
    @Autowired
    private TestEntityManager entityManager;
}
```

- **`@DataJpaTest` ==>** sử dụng để kiểm thử các **`repository`** và các **`component`** liên quan đến JPA (Java Persistence API).Cung cấp các tính năng như:
    - Tự động cấu hình H2 database in-memory, tự động cấu hình Hibernate, đặt lên class test các repository và component liên quan đến JPA.
    - **`showSql` ==>** mặc định là **`true`**, khi chạy test sẽ show câu lệnh sql ở console
- **`@AutoConfigureTestDatabase` ==>** Sử dụng để cấu hình cơ sở dữ liệu tạm thời. Dưới đây là các thuộc tính:
    - **`replace` ==>** Sử dụng để thay thế cấu hình cơ sở dữ liệu
        - **`Replace.NONE`** (mặc định) sẽ không thay thế cấu hình cơ sở dữ liệu. 
        - **`Replace.ANY`** sẽ thay thế cấu hình cơ sở dữ liệu bằng một cấu hình cơ sở dữ liệu tạm thời.
    - **`type`**: Loại cơ sở dữ liệu tạm thời sẽ được sử dụng, mặc định là **`TestDatabaseType.H2`**, ngoài ra còn có **`POSTGRESQL, MYSQL, ORACLE,...`**.
    - **`initScripts`**: Danh sách các script SQL sẽ được thực thi để khởi tạo cơ sở dữ liệu.
    - **`properties`**: Các thuộc tính được sử dụng để cấu hình cơ sở dữ liệu tạm thời.
- **`@Rollback` ==>** sử dụng để chỉ định rằng các thay đổi dữ liệu trong cơ sở dữ liệu trong quá trình kiểm thử có rollback lại không.
    - Mặc định là **`true`** khi sử dụng **`@DataJpaTest`**, mọi kiểm thử trong **transaction sẽ được rollback** sau khi test xong.
    - **`false`** sẽ giữ lại các thay đổi, cập nhật trực tiếp vào database.
    - Vị trí sử dụng **`@Rollback`** có thể là ở **trên class hoặc trên method**. 
- **`@Autowired` ==>** tự động inject các dependency vào trong một class.
    - Sử dụng **trên thuộc tính** sẽ tự động tìm kiếm các bean phù hợp với kiểu dữ liệu của thuộc tính đó và inject vào trong đối tượng hiện tại.    


**[⬆ Quay trở lại đầu trang](#mục-lục-nội-dung)**

## 2. Test save

```java
@Test
public void testCreateOneRole() {
    Role roleAdmin = new Role();
    roleAdmin.setName("admin");
    Role savedRole = repo.save(roleAdmin);
    assertThat(savedRole.getId()).isGreaterThan(0);
}

@Test
public void testCreateMultipleRoles() {
    Role roleSalesperson = new Role();
    roleSalesperson.setName("salesperson");
    Role roleEditor = new Role();
    roleEditor.setName("editor");
    repo.saveAll(List.of(roleSalesperson, roleEditor));
}
```

**[⬆ Quay trở lại đầu trang](#mục-lục-nội-dung)**

## 3. Test get

```java
@Test
public void testGetUserById() {
    User user = repo.findById(1).get()
    assertThat(user).isNotNull();
}
```

**[⬆ Quay trở lại đầu trang](#mục-lục-nội-dung)**

## 4. Test update

```java
@Test
public void testUpdateUserRoles() {
    Role shipperEmployee = entityManager.find(Role.class, 3);
    Role editorEmployee = entityManager.find(Role.class, 4);
    User user = repo.findById(3).get();
    user.getRoles().remove(shipperEmployee); // remove of sort
    user.addRole(editorEmployee);
    repo.save(user);
}
```

**[⬆ Quay trở lại đầu trang](#mục-lục-nội-dung)**

## 5. Test delete

```java
@Test
public void testDeleteUser() {
    Integer userId = 3;
    repo.deleteById(userId);
}
```

**[⬆ Quay trở lại đầu trang](#mục-lục-nội-dung)**

## 6. Test listAll

```java
@Test
public void testListAllUsers() {
    Iterable<User> users = repo.findAll();
    users.forEach(System.out::println); // users.forEach(user -> System.out.println(user));
}
```

**[⬆ Quay trở lại đầu trang](#mục-lục-nội-dung)**

## 7. Test findBy

```java
@Test
public void testListAllUsers() {
    String email = "thong@gmail.com";
    User userByEmail = repo.findByEmail(email);
    assertThat(userByEmail).isNotNull();
}
```

**[⬆ Quay trở lại đầu trang](#mục-lục-nội-dung)**

## 8. Test count

```java
@Test
public void testCountById() {
    Integer id = 1;
    Long countById = repo.countById(id);
    assertThat(countById).isNotNull().isGreaterThan(0);
}
```

**[⬆ Quay trở lại đầu trang](#mục-lục-nội-dung)**

## Xem thêm bài viết khác

- [Repository](Day004.md) 
- [SpringBoot Application](Day006.md) 






