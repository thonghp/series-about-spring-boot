# Chức năng

## Mục lục nội dung

- [1. Trả về danh sách](#1-trả-về-danh-sách)
- [2. Hiển thị form](#2-hiển-thị-form)
- [3. Lưu form xuống db](#3-lưu-form-xuống-db)
- [4. Mã hoá mật khẩu với bcrypt](#4-mã-hoá-mật-khẩu-với-bcrypt)
- [5. Check email trùng](#5-check-email-trùng)
- [6. Cập nhật thông tin](#6-cập-nhật-thông-tin)

## 1. Trả về danh sách

- Để trả về danh sách tất cả user **==>** sử dụng **`findAll()`** của repository để lấy ra list **==>** đưa vào model đem qua thymeleaf

```java
@Repository
public interface UserRepository extends CrudRepository<User, Integer> {}

@Service
public class UserService {
    @Autowired
    private UserRepository userRepo;
    public List<User> listAll() {
        return (List<User>) userRepo.findAll();
    }
}

@Controller
public class UserController {
    @Autowired
    private UserService userService;
    @GetMapping("/users")
    public String listAll(Model model) {
        List<User> users = userService.listAll();
        model.addAttribute("users", users);
        return "users";
    }
}

// user.html
<tr th:each="user : ${users}">
    <td>[[${user.id}]]</td>
    ...
</tr>
```

**[⬆ Quay trở lại đầu trang](#mục-lục-nội-dung)**

## 2. Hiển thị form

- Nhấn vào button thêm để chuyển tới form **==>** tạo button chứa url gọi tới controller **==>** controller xử lý request trả về trang form

```java
// user.html
<div>
    <a th:href="@{/users/new}">Thêm nhân viên</a>
</div>

@GetMapping("/users/new")
public String newUser(Model model) {
    User user = new User();
    model.addAttribute("user", user);
    return "user_form";
}
```

**[⬆ Quay trở lại đầu trang](#mục-lục-nội-dung)**

## 3. Lưu form xuống db

- Nhập thông tin vào form rồi submit **==>** controller sẽ xử lý request gửi về sau đó lưu xuống db

```java
// user_form.html
<form th:action="@{/users/save}" method="post" th:object="${user}">
<input type="email" th:field="*{email}"/>
...
</form>

@PostMapping("/users/save")
public String saveUser(User user) {
    userService.save(user);
    return "redirect:/users";
}

// service
public void save(User user) {
    userRepo.save(user);
}
```

**[⬆ Quay trở lại đầu trang](#mục-lục-nội-dung)**

## 4. Mã hoá mật khẩu với bcrypt

Để mã hoá mật khẩu **==>** viết 1 lớp config và khai báo bean bcrypt **==>** viết phương thức xử lý encode password ở service

```java
// configuration
@Configuration
@EnableWebSecurity
public class WebSecurityConfig extends WebSecurityConfigurerAdapter {
    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http.authorizeHttpRequests().anyRequest().permitAll();
    }
}

// service
@Autowired
private PasswordEncoder passwordEncoder;
private void encodePassword(User user) {
    String encodedPassword = passwordEncoder.encode(user.getPassword());
    user.setPassword(encodedPassword);
}
public void save(User user) {
    encodePassword(user);
    userRepo.save(user);
}
```

**[⬆ Quay trở lại đầu trang](#mục-lục-nội-dung)**

## 5. Check email trùng

Để kiểm tra email trùng **==>** viết hàm jquery/js bất đồng bộ gửi **`email, csrf, id`** về restcontroller **==>** restcontroller tiến hành xử lý kiểm tra xem tồn tại chưa thông qua method ở **`service`** sau đó trả lại **`json`** gửi về client

```java
// user_form
<input type="hidden" th:field="*{id}">
<input type="email" th:field="*{email}" name="email"/>
<div id="email-status"></div>

<script type="text/javascript">
  $(document).ready(function () {
    // lấy object input có name là email
    let emailInput = $('input[name="email"]');
    let emailStatus = $("#email-status");
    let url = "[[@{/users/check_email}]]";

    // Kiểm tra email khi người dùng rời khỏi trường email hoặc thay đổi nội dung trường
    /*
     * blur : bỏ chọn 1 trường input hoặc click vào một phần tử khác trên trang web sự kiện này sẽ được gọi
     * keyup: khi người dùng nhấn phím trên bàn phím sự kiện này sẽ được gọi
     * có thể sử dụng kết hợp 2 cái này cùng lúc "blur keyup"
     */
    emailInput.on("blur", function () {
      let email = $(this).val(); // lấy giá trị email được nhập
      let csrfToken = $('input[name="_csrf"]').val();
      if (email !== "") {
        $.ajax({
          url: url,
          type: "POST",
          data: { email: email, _csrf: csrfToken },
          success: function (data) {
            if (data === "OK") {
              emailStatus.html("");
            } else if (data === "Duplicated") {
              emailStatus.html(
                '<span style="color:red">Email đã tồn tại</span>'
              );
            }
          },
        });
      } else {
        //  khi trường email rỗng, đoạn mã sẽ xóa bỏ thông báo lỗi trùng email nếu có và hiển thị trường email trống
        emailStatus.empty();
      }
    });
  });
</script>

@RestController
public class UserRestController {
    @Autowired
    private UserService userService;
    @PostMapping("/users/check_email")
    public String checkDuplicateEmail(@RequestParam(value = "id", required = false) Integer id, @RequestParam("email") String email) {
        return userService.isEmailUnique(id, email) ? "OK" : "Duplicated";
    }
}

// service
public boolean isEmailUnique(Integer id, String email) {
    User userByEmail = userRepo.findByEmail(email);
    boolean isExistedId = (id != null);
    if (isExistedId) {
        return userByEmail.getId().equals(id);
    } else {
        return userByEmail == null;
    }
}

@Repository
public interface UserRepository extends CrudRepository<User, Integer> {
    User findByEmail(String email);
}
```

**[⬆ Quay trở lại đầu trang](#mục-lục-nội-dung)**

## 6. Cập nhật thông tin

Cập nhật user **==>** chọn user muốn cập nhật **==>** controller tiến hành xử lý lấy thông tin của user đó đổ ra form **==>** thay đổi thông tin xong cập nhật 

```java
<a th:href="@{'/users/edit/' + ${user.id}}"></a>

@GetMapping("/users/edit/{id}")
public String editUser(@PathVariable(name = "id") Integer id, Model model, RedirectAttributes redirectAttributes) {
    try {
        User user = userService.get(id);
        model.addAttribute("user", user);      
        return "user_form";
    } catch (UserNotFoundException ex) {
        redirectAttributes.addFlashAttribute("message", ex.getMessage())        
        return "redirect:/users";
    }
}

// service
public User get(Integer id) throws UserNotFoundException {
    try {
        return userRepo.findById(id).get();
    } catch (Exception ex) {
        /*
         * 1 khi sử dụng throw thì phải luôn dùng throws vì chắc chắn 
         * method này sẽ có trường hợp không thoả lúc đó sẽ ném throw 
         * thì buộc method phải throws để khi sử dụng method này ở nơi khác
         * sẽ phải bắt ngoại lệ throw xảy ra
         */ 
        throw new UserNotFoundException("Không tìm thấy nhân viên có id là " + id);
    }
}

public void save(User user) {
    boolean isExistingId = (user.getId() != null);
    if (isExistingId) {
        User existingUser = userRepo.findById(user.getId()).get();
        if (user.getPassword().isEmpty()) {
            user.setPassword(existingUser.getPassword());
        } else {
            encodePassword(user);
        }
    } else {
        encodePassword(user);
    }
    userRepo.save(user);
}
```

**[⬆ Quay trở lại đầu trang](#mục-lục-nội-dung)**

## Xem thêm bài viết khác

- [Spring security](Day010.md)
